<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniTech Community Chat</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; overflow: hidden; }
        
        /* --- Login Screen --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 10px; text-align: center; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box h2 { color: #333; margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .login-box button:hover { background: #2980b9; }

        /* --- Dashboard Sidebar --- */
        .sidebar { width: 280px; background: #2c3e50; color: white; display: flex; flex-direction: column; height: 100vh; flex-shrink: 0; }
        .sidebar-header { padding: 20px; font-weight: bold; font-size: 1.2rem; background: #1a252f; flex-shrink: 0; border-bottom: 1px solid #34495e; }
        
        .list-section { padding: 15px 20px 5px; font-size: 0.85rem; color: #95a5a6; text-transform: uppercase; font-weight: bold; flex-shrink: 0; }
        
        .list-container { flex: 1; overflow-y: auto; min-height: 0; margin-bottom: 10px; }
        .list-container::-webkit-scrollbar { width: 6px; }
        .list-container::-webkit-scrollbar-thumb { background: #566573; border-radius: 3px; }

        .item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; transition: background 0.2s; }
        .item:hover { background: #34495e; }
        .item.active { background: #2980b9; border-left: 4px solid #3498db; }
        .room-icon { margin-right: 10px; opacity: 0.7; }
        .status { width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; margin-right: 10px; }

        /* --- Chat Area --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: white; min-width: 0; }
        .chat-header { padding: 15px 25px; border-bottom: 1px solid #ddd; font-weight: bold; background: #fff; font-size: 1.1rem; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .messages { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f8f9fa; }
        
        .input-area { padding: 20px; background: white; border-top: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
        .input-area input { flex: 1; padding: 12px 20px; border: 1px solid #ccc; border-radius: 30px; outline: none; font-size: 1rem; }
        .input-area button { padding: 10px 25px; background: #3498db; color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; }
        .input-area button:hover { background: #2980b9; }

        .message { padding: 10px 16px; border-radius: 18px; max-width: 70%; word-wrap: break-word; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .my-msg { align-self: flex-end; background: #3498db; color: white; border-bottom-right-radius: 4px; }
        .other-msg { align-self: flex-start; background: #e9ecef; color: #333; border-bottom-left-radius: 4px; }
        .meta { font-size: 0.7rem; margin-bottom: 4px; font-weight: bold; opacity: 0.8; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>ðŸŽ“ UniTech Login</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Enter Community</button>
        </div>
    </div>

    <div id="dashboard" class="hidden" style="display: flex; width: 100%;">
        <div class="sidebar">
            <div class="sidebar-header">UniTech Community</div>
            <div class="list-section">ðŸ“š Tech Rooms</div>
            <div id="rooms-list" class="list-container"></div>
            <div class="list-section">ðŸ’¬ Direct Messages</div>
            <div id="users-list" class="list-container"></div>
            <div style="padding: 15px; border-top: 1px solid #34495e;">
                <button onclick="logout()" style="width: 100%; padding: 8px; background: transparent; border: 1px solid #95a5a6; color: #bdc3c7; border-radius: 4px; cursor: pointer;">Logout</button>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header" id="chat-header">ðŸ‘‹ Welcome! Select a Room</div>
            <div class="messages" id="messages-box"></div>
            <div class="input-area">
                <input type="text" id="msg-input" placeholder="Type your problem here..." onkeypress="handleEnter(event)">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000";
        let currentUser = null;
        let ws = null;
        let activeType = null;
        let activeTarget = null;

        async function login() {
            // à¶¸à·™à¶±à·Šà¶± à¶¸à·™à¶­à¶± à¶­à¶¸à¶ºà·’ à¶…à¶» IDs à·€à¶½à·’à¶±à·Š data à¶œà¶±à·Šà¶±à·š
            const uInput = document.getElementById('username');
            const pInput = document.getElementById('password');

            const u = uInput.value.trim();
            const p = pInput.value.trim();

            console.log("Username Typed:", u); // Debugging à·ƒà¶³à·„à·
            console.log("Password Typed:", p); // Debugging à·ƒà¶³à·„à·

            if(!u || !p) return alert("Please fill all fields");

            try {
                await fetch(`${API_URL}/register`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username: u, email: u+"@test.com", password: p})
                });
            } catch(e) {} 
            
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({username: u, password: p})
            });

            if(res.ok) {
                currentUser = u;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('dashboard').style.display = 'flex';
                initApp();
            } else { alert("Login Failed"); }
        }

        function initApp() {
            loadRooms();
            loadUsers();
            connectWS();
        }

        function connectWS() {
            ws = new WebSocket(`ws://127.0.0.1:8000/ws/${currentUser}`);
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'channel' && activeType === 'channel' && data.channel === activeTarget) {
                    displayMessage(data.sender, data.content);
                }
                if (data.type === 'private' && activeType === 'private') {
                    if (data.sender === activeTarget || (data.sender === currentUser && data.recipient === activeTarget)) {
                        displayMessage(data.sender, data.content);
                    }
                }
            };
            ws.onclose = () => { setTimeout(connectWS, 3000); };
        }

        async function loadRooms() {
            const res = await fetch(`${API_URL}/channels`);
            const rooms = await res.json();
            const box = document.getElementById('rooms-list');
            box.innerHTML = "";
            rooms.forEach(r => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<span class="room-icon">#</span> ${r.name}`;
                div.onclick = () => selectChat('channel', r.name, div);
                box.appendChild(div);
            });
        }

        async function loadUsers() {
            const res = await fetch(`${API_URL}/users/${currentUser}`);
            const users = await res.json();
            const box = document.getElementById('users-list');
            box.innerHTML = "";
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<div class="status"></div> ${u.username}`;
                div.onclick = () => selectChat('private', u.username, div);
                box.appendChild(div);
            });
        }

        async function selectChat(type, target, elem) {
            activeType = type;
            activeTarget = target;
            document.querySelectorAll('.item').forEach(e => e.classList.remove('active'));
            elem.classList.add('active');
            
            const icon = type === 'channel' ? '#' : 'ðŸ‘¤';
            document.getElementById('chat-header').innerText = `${icon} ${target}`;
            document.getElementById('messages-box').innerHTML = "";

            const url = type === 'channel' 
                ? `${API_URL}/messages/channel/${target}` 
                : `${API_URL}/messages/private/${currentUser}/${target}`;
            
            const res = await fetch(url);
            const msgs = await res.json();
            msgs.forEach(m => displayMessage(m.sender, m.content));
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const content = input.value.trim();
            if(!content || !activeTarget) return;

            const payload = { type: activeType, target: activeTarget, content: content };
            ws.send(JSON.stringify(payload));
            input.value = "";
        }

        function displayMessage(sender, content) {
            const box = document.getElementById('messages-box');
            const div = document.createElement('div');
            const isMe = sender === currentUser;
            div.className = `message ${isMe ? 'my-msg' : 'other-msg'}`;
            div.innerHTML = `<div class="meta">${isMe ? 'You' : sender}</div><div>${content}</div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        function logout() { location.reload(); }
    </script>
</body>
</html>